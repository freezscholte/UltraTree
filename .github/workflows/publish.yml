# Publish to PowerShell Gallery on release
# https://docs.github.com/en/actions/publishing-packages/publishing-nodejs-packages

name: Publish to PowerShell Gallery

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  publish:
    name: Publish Module
    runs-on: windows-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Install NuGet
        shell: powershell
        run: Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force

      - name: Install PowerShellGet
        shell: powershell
        run: Install-Module -Name PowerShellGet -Repository PSGallery -Force

      - name: Bootstrap dependencies
        shell: powershell
        run: ./Module/actions_bootstrap.ps1

      - name: Build module
        shell: powershell
        run: Invoke-Build -File .\Module\src\UltraTree.build.ps1 -Task Clean, Build

      - name: Publish to PowerShell Gallery
        shell: powershell
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $modulePath = ".\Module\src\Artifacts"

          # Verify module exists
          if (-not (Test-Path "$modulePath\UltraTree.psd1")) {
            Write-Error "Module manifest not found at $modulePath"
            Get-ChildItem $modulePath -Recurse | ForEach-Object { Write-Output $_.FullName }
            exit 1
          }

          # Get module version
          $manifest = Import-PowerShellDataFile "$modulePath\UltraTree.psd1"
          Write-Output "Publishing UltraTree version $($manifest.ModuleVersion)"

          # Publish
          Publish-Module -Path $modulePath -NuGetApiKey $env:PSGALLERY_API_KEY -Verbose

          Write-Output "Successfully published UltraTree $($manifest.ModuleVersion) to PowerShell Gallery"
